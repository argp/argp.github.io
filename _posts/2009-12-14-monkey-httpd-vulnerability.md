---
title: "Advisory: Monkey HTTPd improper input validation vulnerability"
layout: post
tags:
  - advisories
  - census
  - exploit
  - exploitation
  - monkey
  - research
  - security
---

CENSUS ID          | CENSUS-2009-0004
------------------ | ----------------
Affected products: | Monkey web server versions â‰¤ 0.9.2
Class:             | Improper Input Validation (CWE-20), Incorrect Calculation (CWE-682)
Remote:            | Yes
Discovered by:     | Patroklos Argyroudis

We have discovered a remotely exploitable "improper input 
validation" vulnerability in the Monkey web server that allows an 
attacker to perform denial of service attacks by repeatedly crashing worker 
threads that process HTTP requests.

### Details

[Monkey](http://www.monkey-project.com/) is a fast, efficient, small and easy to
configure HTTP/1.1 compliant web server. It has been designed to be scalable with
low memory and CPU consumption. More information about its features can be found
[here](http://www.monkey-project.com/about).

Monkey (up to and including version 0.9.2) employs an insufficient input 
validation method for handling HTTP requests with invalid connection headers. 
Specifically, the vulnerability is in the calculation for the end of the 
request body buffer related to newline characters in function 
`Request_Find_Variable()` in the file `src/request.c`:

{% highlight c linenos=table %}
char *Request_Find_Variable(char *request_body,  char *string)
{
   int pos_init_var=, pos_end_var=;
   char *var_value = ;
 
   /* Existe *string en request_body ??? */        
   if (strstr2(request_body, string) == NULL)
       return NULL;
 
   pos_init_var = str_search(request_body, string, strlen(string));
   pos_end_var = str_search(request_body+pos_init_var, "\n", 1) - 1;
 
   if(pos_init_var<= || pos_end_var<=){
       return  NULL;   
   }
 
   pos_init_var += strlen(string) + 1;
   pos_end_var = (unsigned int) (pos_init_var  + pos_end_var) - (strlen(string) +1);
 
   var_value = m_copy_string(request_body, pos_init_var, pos_end_var);
 
   return (char *) var_value;
}
{% endhighlight %}

With a specially crafted request body the `pos_init_var` integer can take the 
value `0x1c` (`28` in decimal) and the `pos_end_var` integer can take the value 
`0x1a` (`26` in decimal). Then in the `m_copy_string()` function, the 
calculation for the unsigned integer `size` in line 428 (file `src/utils.c`) 
leads to a signedness bug and `m_copy_string()` returns NULL (line 438, file 
`src/utils.c`):

{% highlight c linenos=table %}
char *m_copy_string(const char *string, int pos_init, int pos_end)
{
   unsigned int size, bytes;
   char *buffer=;
 
   size = (unsigned int) (pos_end &mdash; pos_init ) + 1;
   if(size<=2) size=4;
 
   buffer = M_malloc(size);
 
   if(!buffer){
       return NULL;
   }
 
   if(pos_end>strlen(string) || (pos_init > pos_end)){
       return NULL;
   }
{% endhighlight %}

This causes `Request_Find_Variable()` to return NULL (line 344, file 
`src/request.c`) and this to be used in the `strstr2()` call at line 345 of 
file `src/request.c`:

{% highlight c linenos=table %}
sr->connection = Request_Find_Variable(request_body, RH_CONNECTION);
if((strstr2(sr->connection,"Keep-Alive"))!=NULL){
    sr->keep_alive=VAR_ON;
}
{% endhighlight %}

This vulnerability can allow an attacker to perform denial of service attacks 
by repeatedly crashing Monkey worker threads that process HTTP requests. We 
have developed [a proof-of-concept exploit](http://census-labs.com/media/monkeyex.txt)
to demonstrate the vulnerability.

The maintainer of Monkey has been contacted and a new version of the web server 
(0.9.3) has been [released](http://www.monkey-project.com/downloads) that addresses
this issue. All affected parties  are advised to upgrade to the latest version available.
