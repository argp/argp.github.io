---
id: 166
title: Monkey HTTPd improper input validation vulnerability
author: argp
layout: post
guid: http://argp.gr/blog/?p=166
permalink: /2009/12/14/monkey-httpd-vulnerability/
aktt_notify_twitter:
  - no
categories:
  - advisories
  - exploitation
  - research
  - security
tags:
  - advisories
  - census
  - exploit
  - exploitation
  - monkey
  - research
  - security
---
<table>
  <tr>
    <td>
      census ID:
    </td>
    
    <td>
      census-2009-0004
    </td>
  </tr>
  
  <tr>
    <td>
      Affected Products:
    </td>
    
    <td>
      Monkey web server versions &le; 0.9.2.
    </td>
  </tr>
  
  <tr>
    <td>
      Class:
    </td>
    
    <td>
      Improper Input Validation (<a href="http://cwe.mitre.org/data/definitions/20.html">CWE-20</a>), Incorrect Calculation (<a href="http://cwe.mitre.org/data/definitions/682.html">CWE-682</a>)
    </td>
  </tr>
  
  <tr>
    <td>
      Remote:
    </td>
    
    <td>
      Yes
    </td>
  </tr>
  
  <tr>
    <td>
      Discovered by:
    </td>
    
    <td>
      Patroklos Argyroudis
    </td>
  </tr>
</table>

We have discovered a remotely exploitable &#8220;improper input validation&#8221; vulnerability in the Monkey web server that allows an attacker to perform denial of service attacks by repeatedly crashing worker threads that process HTTP requests.

### Details

[Monkey][1] is a fast, efficient, small and easy to configure HTTP/1.1 compliant web server. It has been designed to be scalable with low memory and CPU consumption. More information about its features can be found [here][2].

Monkey (up to and including version 0.9.2) employs an insufficient input validation method for handling HTTP requests with invalid connection headers. Specifically, the vulnerability is in the calculation for the end of the request body buffer related to newline characters in function `Request_Find_Variable()` in the file `src/request.c`:

<div class="wp_syntax">
  <table>
    <tr>
      <td class="line_numbers">
        <pre>364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
</pre>
      </td>
      
      <td class="code">
        <pre class="c" style="font-family:monospace;"><span style="color: #993333;">char</span> <span style="color: #339933;">*</span>Request_Find_Variable<span style="color: #009900;">&#40;</span><span style="color: #993333;">char</span> <span style="color: #339933;">*</span>request_body<span style="color: #339933;">,</span>  <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>string<span style="color: #009900;">&#41;</span>
<span style="color: #009900;">&#123;</span>
   <span style="color: #993333;">int</span> pos_init_var<span style="color: #339933;">=</span><span style="color: #0000dd;"></span><span style="color: #339933;">,</span> pos_end_var<span style="color: #339933;">=</span><span style="color: #0000dd;"></span><span style="color: #339933;">;</span>
   <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>var_value <span style="color: #339933;">=</span> <span style="color: #0000dd;"></span><span style="color: #339933;">;</span>
&nbsp;
   <span style="color: #808080; font-style: italic;">/* Existe *string en request_body ??? */</span>        
   <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span>strstr2<span style="color: #009900;">&#40;</span>request_body<span style="color: #339933;">,</span> string<span style="color: #009900;">&#41;</span> <span style="color: #339933;">==</span> NULL<span style="color: #009900;">&#41;</span>
       <span style="color: #b1b100;">return</span> NULL<span style="color: #339933;">;</span>
&nbsp;
   pos_init_var <span style="color: #339933;">=</span> str_search<span style="color: #009900;">&#40;</span>request_body<span style="color: #339933;">,</span> string<span style="color: #339933;">,</span> <span style="color: #000066;">strlen</span><span style="color: #009900;">&#40;</span>string<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
   pos_end_var <span style="color: #339933;">=</span> str_search<span style="color: #009900;">&#40;</span>request_body<span style="color: #339933;">+</span>pos_init_var<span style="color: #339933;">,</span> <span style="color: #ff0000;">"<span style="color: #000099; font-weight: bold;">\n</span>"</span><span style="color: #339933;">,</span> <span style="color: #0000dd;">1</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">-</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
&nbsp;
   <span style="color: #b1b100;">if</span><span style="color: #009900;">&#40;</span>pos_init_var<span style="color: #339933;">&lt;=</span><span style="color: #0000dd;"></span> <span style="color: #339933;">||</span> pos_end_var<span style="color: #339933;">&lt;=</span><span style="color: #0000dd;"></span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
       <span style="color: #b1b100;">return</span>  NULL<span style="color: #339933;">;</span>   
   <span style="color: #009900;">&#125;</span>
&nbsp;
   pos_init_var <span style="color: #339933;">+=</span> <span style="color: #000066;">strlen</span><span style="color: #009900;">&#40;</span>string<span style="color: #009900;">&#41;</span> <span style="color: #339933;">+</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
   pos_end_var <span style="color: #339933;">=</span> <span style="color: #009900;">&#40;</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#40;</span>pos_init_var  <span style="color: #339933;">+</span> pos_end_var<span style="color: #009900;">&#41;</span> <span style="color: #339933;">-</span> <span style="color: #009900;">&#40;</span><span style="color: #000066;">strlen</span><span style="color: #009900;">&#40;</span>string<span style="color: #009900;">&#41;</span> <span style="color: #339933;">+</span><span style="color: #0000dd;">1</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
   var_value <span style="color: #339933;">=</span> m_copy_string<span style="color: #009900;">&#40;</span>request_body<span style="color: #339933;">,</span> pos_init_var<span style="color: #339933;">,</span> pos_end_var<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
   <span style="color: #b1b100;">return</span> <span style="color: #009900;">&#40;</span><span style="color: #993333;">char</span> <span style="color: #339933;">*</span><span style="color: #009900;">&#41;</span> var_value<span style="color: #339933;">;</span>
<span style="color: #009900;">&#125;</span></pre>
      </td>
    </tr>
  </table>
</div>

With a specially crafted request body the `pos_init_var` integer can take the value `0x1c` (`28` in decimal) and the `pos_end_var` integer can take the value `0x1a` (`26` in decimal). Then in the `m_copy_string()` function, the calculation for the unsigned integer `size` in line 428 (file `src/utils.c`) leads to a signedness bug and `m_copy_string()` returns NULL (line 438, file `src/utils.c`):

<div class="wp_syntax">
  <table>
    <tr>
      <td class="line_numbers">
        <pre>423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
</pre>
      </td>
      
      <td class="code">
        <pre class="c" style="font-family:monospace;"><span style="color: #993333;">char</span> <span style="color: #339933;">*</span>m_copy_string<span style="color: #009900;">&#40;</span><span style="color: #993333;">const</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>string<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> pos_init<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> pos_end<span style="color: #009900;">&#41;</span>
<span style="color: #009900;">&#123;</span>
   <span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span> size<span style="color: #339933;">,</span> bytes<span style="color: #339933;">;</span>
   <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>buffer<span style="color: #339933;">=</span><span style="color: #0000dd;"></span><span style="color: #339933;">;</span>
&nbsp;
   size <span style="color: #339933;">=</span> <span style="color: #009900;">&#40;</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#40;</span>pos_end <span style="color: #339933;">&</span>mdash<span style="color: #339933;">;</span> pos_init <span style="color: #009900;">&#41;</span> <span style="color: #339933;">+</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>
   <span style="color: #b1b100;">if</span><span style="color: #009900;">&#40;</span>size<span style="color: #339933;">&lt;=</span><span style="color: #0000dd;">2</span><span style="color: #009900;">&#41;</span> size<span style="color: #339933;">=</span><span style="color: #0000dd;">4</span><span style="color: #339933;">;</span>
&nbsp;
   buffer <span style="color: #339933;">=</span> M_malloc<span style="color: #009900;">&#40;</span>size<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
   <span style="color: #b1b100;">if</span><span style="color: #009900;">&#40;</span><span style="color: #339933;">!</span>buffer<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
       <span style="color: #b1b100;">return</span> NULL<span style="color: #339933;">;</span>
   <span style="color: #009900;">&#125;</span>
&nbsp;
   <span style="color: #b1b100;">if</span><span style="color: #009900;">&#40;</span>pos_end<span style="color: #339933;">&gt;</span><span style="color: #000066;">strlen</span><span style="color: #009900;">&#40;</span>string<span style="color: #009900;">&#41;</span> <span style="color: #339933;">||</span> <span style="color: #009900;">&#40;</span>pos_init <span style="color: #339933;">&gt;</span> pos_end<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
       <span style="color: #b1b100;">return</span> NULL<span style="color: #339933;">;</span>
   <span style="color: #009900;">&#125;</span></pre>
      </td>
    </tr>
  </table>
</div>

This causes `Request_Find_Variable()` to return NULL (line 344, file `src/request.c`) and this to be used in the `strstr2()` call at line 345 of file `src/request.c`:

<div class="wp_syntax">
  <table>
    <tr>
      <td class="line_numbers">
        <pre>344
345
346
347
</pre>
      </td>
      
      <td class="code">
        <pre class="c" style="font-family:monospace;">sr<span style="color: #339933;">-&gt;</span>connection <span style="color: #339933;">=</span> Request_Find_Variable<span style="color: #009900;">&#40;</span>request_body<span style="color: #339933;">,</span> RH_CONNECTION<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #b1b100;">if</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#40;</span>strstr2<span style="color: #009900;">&#40;</span>sr<span style="color: #339933;">-&gt;</span>connection<span style="color: #339933;">,</span><span style="color: #ff0000;">"Keep-Alive"</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">!=</span>NULL<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
    sr<span style="color: #339933;">-&gt;</span>keep_alive<span style="color: #339933;">=</span>VAR_ON<span style="color: #339933;">;</span>
<span style="color: #009900;">&#125;</span></pre>
      </td>
    </tr>
  </table>
</div>

This vulnerability can allow an attacker to perform denial of service attacks by repeatedly crashing Monkey worker threads that process HTTP requests. We have developed [a proof-of-concept exploit][3] to demonstrate the vulnerability.

The maintainer of Monkey has been contacted and a new version of the web server (0.9.3) has been [released][4] that addresses this issue. All affected parties are advised to upgrade to the latest version available.

 [1]: http://www.monkey-project.com/
 [2]: http://www.monkey-project.com/about
 [3]: http://census-labs.com/media/monkeyex.txt
 [4]: http://www.monkey-project.com/downloads